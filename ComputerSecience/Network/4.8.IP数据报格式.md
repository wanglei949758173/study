# IP数据报格式
IP数据报由 **首部** 和 **数据部分** 两部分组成。

## 首部
首部的前一部分是 **固定长度**，共 20 字节，是所有 IP 数据报 **必须具有的**。

在首部的固定部分的后面是一些可选字段，其长度是可变的。

![ip-datagram-header](./assets/ip-datagram-header.png)

### 版本
占 4 位，指 IP 协议的版本
目前的 IP 协议版本号为 4 (即 IPv4)

### 首部长度
占 4 位，可表示的最大数值
是 15 个单位(单位为 4 字节)
因此 IP 的首部长度的最大值是 60 字节。

### 区分服务
占 8 位，用来获得更好的服务，比如在带宽比较低的情况下标记这个数据包优先发送。
在旧标准中叫做服务类型，但实际上一直未被使用过。
1998 年这个字段改名为区分服务。
只有在使用区分服务（DiffServ）时，这个字段才起作用。
在一般的情况下都不使用这个字段。

### 总长度
占 16 位，指首部和数据之和的长度，
单位为字节，因此数据报的最大长度为 65535 字节。
总长度必须不超过最大传送单元 MTU。


![ip-datagram-header](./assets/ip-datagram-header.png)

### 标识(identification)
IP软件在存储器中维持一个计数器，每产生一个数据包，计数器就加1，并将此值赋给标识字段。

**但这个“标识”并不是序号**，因为IP是无连接服务，数据包不存在按序接收的问题。当数据包由于 **长度超过网络的MTU而必须分片** 时，同一个数据包被分成多个片，这些片的标识都一样，也就是数据包这个标识字段的值就被复制到所有的数据包分片的标识字段中。相同的标识字段的值使分片后的各数据包片最后能正确地重装成为原来的数据包。

![ip-datagram-header](./assets/ip-datagram-header.png)

### 标志(flag)
占 3 位，目前只有前两位有意义。

标志字段的最低位是 MF (More Fragment)。
MF = 1 表示后面“还有分片”。MF = 0 表示最后一个分片。

标志字段中间的一位是 DF (Don't Fragment) 。
只有当 DF = 0 时才允许分片。

### 片偏移(13 位)
某片在原分组中的相对位置。

片偏移以 8 个字节为偏移单位。
![ip-datagram-sharding](./assets/ip-datagram-sharding.png)

![ip-datagram-header](./assets/ip-datagram-header.png)

### 生存时间(8 位)
记为 TTL (Time To Live)
数据报在网络中可通过的路由器数的最大值。

### 协议(8 位)
字段指出此数据报携带的数据使用何种协议(TCP、UDP、ICMP、IGMP...)
以便目的主机的 IP 层将数据部分上交给哪个处理进程

### 首部检验和(16 位)
字段只检验数据报的首部
不检验数据部分。
这里不采用 CRC 检验码而采用简单的计算方法。
![ip-datagram-header-checksum](./assets/ip-datagram-header-checksum.png)

### 源地址(4个字节)

### 目的地址(4个字节)

![ip-datagram-header](./assets/ip-datagram-header.png)

### 可选字段
IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。
选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目。
增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。
实际上这些选项很少被使用。  

### 填充
保证IP数据报头部的大小是 **4字节** 的整数倍。
